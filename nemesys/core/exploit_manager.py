from nemesys.utils.logger import nemesysLogger

class ExploitManager:
    def __init__(self, client):
        """
        Initializes the ExploitManager with the given client to execute an exploit.

        Args:
            client (MetasploitClient): The Metasploit RPC client instance for interacting with Metasploit.
        """
        self.client = client

    def run(self, exploit_name, payload_name, exploit_options=None, payload_options=None):
        """
        Executes the exploit with the specified parameters and returns the exploit UUID if successful.

        Args:
            exploit_name (str): The name of the exploit to run.
            payload_name (str): The name of the payload to use.
            exploit_options (dict, optional): The options for configuring the exploit module (default is None).
            payload_options (dict, optional): The options for configuring the payload module (default is None).

        Returns:
            str: The UUID of the executed exploit, or None if the execution failed.
        """
        # Default to empty dicts if options are None
        exploit_options = exploit_options or {}
        payload_options = payload_options or {}

        exploit = self.client.modules.use("exploit", exploit_name)
        
        # Configure the exploit with the provided options
        for option, value in exploit_options.items():
            exploit[option] = value

        payload = self.client.modules.use("payload", payload_name)
        
        # Configure the payload with the provided options
        for option, value in payload_options.items():
            payload[option] = value

        nemesysLogger.info(f"üíÄ [EXPLOIT] Injecting exploit '{exploit_name}' with payload '{payload_name}'...")
        
        try:
            # Execute the exploit
            output = exploit.execute(payload=payload)
            nemesysLogger.info("üî• [EXPLOIT] Execution successful. System breached.")
            nemesysLogger.debug(f"üìù [DEBUG] Exploit output: {output}")
            
            # Return the exploit's UUID (unique identifier for the executed exploit)
            return output.get('uuid')
        
        except Exception as e:
            nemesysLogger.error(f"‚ùå [EXPLOIT] Error during execution: {e}")
            return None